name: add to project dependabot

on:
  workflow_call:
    inputs:
      project:
        description: Project ID (classic projects not supported).
        required: true
        type: string
    secrets:
      PROJECT_RW_TOKEN:
        required: true

permissions: {}

jobs:
  add-pr-to-project:
    if: ${{ github.event.pull_request.user.login == 'dependabot[bot]' && ( github.event.action  == 'opened' || github.event.action  == 'reopened') }}
    permissions:
      repository-projects: write
    secrets:
      PROJECT_RW_TOKEN: ${{ secrets.PROJECT_RW_TOKEN }}
    uses: senzing-factory/build-resources/.github/workflows/add-to-project.yaml@v4
    with:
      org: ${{ github.repository_owner }}
      project-number: ${{ inputs.project }}

  move-pr-to-in-progress-column:
    needs: add-pr-to-project
    if: ${{ github.event.pull_request.user.login == 'dependabot[bot]' && ( github.event.action  == 'opened' || github.event.action  == 'reopened') }}
    permissions:
      repository-projects: write
    runs-on: ubuntu-latest
    steps:
      - name: Move PR to In progress
        env:
          GH_TOKEN: ${{ secrets.PROJECT_RW_TOKEN }}
          ORG: ${{ github.repository_owner }}
          PROJECT_NUMBER: ${{ inputs.project }}
          PR_NODE_ID: ${{ github.event.pull_request.node_id }}
        run: |
          # shellcheck disable=SC2016

          # Get the project node ID
          PROJECT_ID=$(gh api graphql -f query='
            query($org: String!, $number: Int!) {
              organization(login: $org) {
                projectV2(number: $number) {
                  id
                }
              }
            }' -f org="$ORG" -F number="$PROJECT_NUMBER" --jq '.data.organization.projectV2.id')

          # Get the item ID for this PR in the project
          ITEM_ID=$(gh api graphql -f query='
            query($project: ID!) {
              node(id: $project) {
                ... on ProjectV2 {
                  items(first: 100) {
                    nodes {
                      id
                      content {
                        ... on PullRequest { id }
                      }
                    }
                  }
                }
              }
            }' -f project="$PROJECT_ID" \
            --jq ".data.node.items.nodes[] | select(.content.id == \"${PR_NODE_ID}\") | .id")

          if [ -z "$ITEM_ID" ]; then
            echo "PR not found in project, skipping status update"
            exit 0
          fi

          # Get the Status field ID and "In progress" option ID
          IFS=' ' read -r FIELD_ID OPTION_ID < <(gh api graphql -f query='
            query($project: ID!) {
              node(id: $project) {
                ... on ProjectV2 {
                  fields(first: 20) {
                    nodes {
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options { id name }
                      }
                    }
                  }
                }
              }
            }' -f project="$PROJECT_ID" \
            --jq '.data.node.fields.nodes[] | select(.name == "Status") | .id + " " + (.options[] | select(.name == "In progress") | .id)')

          # Update the status
          gh api graphql -f query='
            mutation($project: ID!, $item: ID!, $field: ID!, $value: String!) {
              updateProjectV2ItemFieldValue(input: {
                projectId: $project
                itemId: $item
                fieldId: $field
                value: { singleSelectOptionId: $value }
              }) {
                projectV2Item { id }
              }
            }' -f project="$PROJECT_ID" -f item="$ITEM_ID" -f field="$FIELD_ID" -f value="$OPTION_ID"

          echo "Moved PR to 'In progress'"
