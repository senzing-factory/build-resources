name: Claude Pull Request Review

on:
  workflow_call:
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        required: true

permissions: {}

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Install Claude Code CLI
        run: |
          echo "Installing Claude Code CLI..."

          # Download install script
          curl -fsSL https://claude.ai/install.sh -o install.sh

          # Calculate checksum of downloaded script
          SCRIPT_CHECKSUM=$(sha256sum install.sh | awk '{print $1}')
          echo "Install script checksum: $SCRIPT_CHECKSUM"

          # TODO: Verify against known good checksum when available from Claude documentation
          # EXPECTED_CHECKSUM="..."
          # if [ "$SCRIPT_CHECKSUM" != "$EXPECTED_CHECKSUM" ]; then
          #   echo "‚ùå ERROR: Install script checksum verification failed!"
          #   exit 1
          # fi

          # Execute install script
          bash install.sh

          # Add to PATH
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

          # Cleanup
          rm install.sh

      - name: Verify Claude CLI installation
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          # Verify installation succeeded
          if ! command -v claude &> /dev/null; then
            echo "‚ùå ERROR: Claude CLI installation failed"
            exit 1
          fi
          claude --version
          echo "‚úÖ Claude CLI installed successfully"

      - name: Get PR diff
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Fetching PR diff..."
          gh pr diff ${{ github.event.pull_request.number }} > pr_diff.txt || true

          if [ ! -s pr_diff.txt ]; then
            echo "‚ö†Ô∏è  PR diff is empty (no file changes detected)"
            echo "This PR may only contain metadata changes (labels, title, etc.)"
            echo "Skipping code review..."
            echo "SKIP_REVIEW=true" >> "$GITHUB_ENV"
            exit 0
          fi

          echo "‚úÖ PR diff retrieved ($(wc -l < pr_diff.txt) lines)"

      - name: Checkout build resources
        uses: actions/checkout@v6
        with:
          path: build-resources
          persist-credentials: false
          repository: senzing-factory/build-resources

      - name: Verify build resources checkout
        run: |
          if [ ! -f build-resources/claude/pr-prompt.md ]; then
            echo "‚ùå ERROR: Failed to checkout build-resources or pr-prompt.md not found"
            exit 1
          fi

      - name: Create review prompt
        if: env.SKIP_REVIEW != 'true'
        run: |
          cp build-resources/claude/pr-prompt.md prompt-header.md
          echo "‚úÖ Prompt header created"

      - name: Run Claude Code Review
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        if: env.SKIP_REVIEW != 'true'
        run: |
          echo "Running Claude code review..."

          MAX_BYTES=800000  # 800KB limit per chunk to stay well under limits
          DIFF_BYTES=$(wc -c < pr_diff.txt)
          HEADER_BYTES=$(wc -c < prompt-header.md)

          echo "Diff size: $DIFF_BYTES bytes"
          echo "Header size: $HEADER_BYTES bytes"

          # Calculate if we need to chunk
          TOTAL_ESTIMATED=$((HEADER_BYTES + DIFF_BYTES + 200))

          if [ "$TOTAL_ESTIMATED" -gt "$MAX_BYTES" ]; then
            echo "‚ö†Ô∏è Large PR detected, will process in chunks..."

            # Calculate number of chunks needed
            USABLE_BYTES=$((MAX_BYTES - HEADER_BYTES - 200))
            NUM_CHUNKS=$(( (DIFF_BYTES + USABLE_BYTES - 1) / USABLE_BYTES ))

            echo "Processing $NUM_CHUNKS chunks..."

            # Split the diff into chunks by lines to preserve UTF-8 and diff syntax
            TOTAL_LINES=$(wc -l < pr_diff.txt)
            LINES_PER_CHUNK=$(( (TOTAL_LINES + NUM_CHUNKS - 1) / NUM_CHUNKS ))

            echo "Total lines: $TOTAL_LINES, lines per chunk: $LINES_PER_CHUNK"

            split -l "$LINES_PER_CHUNK" -d -a 3 pr_diff.txt chunk_

            # Process chunks in sorted order to ensure deterministic output
            for chunk_file in chunk_*; do
              CHUNK_NUM=$(echo "$chunk_file" | sed 's/chunk_0*//' | sed 's/^$/0/')
              CHUNK_NUM=$((10#$CHUNK_NUM + 1))

              echo ""
              echo "=== Processing chunk $CHUNK_NUM of $NUM_CHUNKS ==="

              # Create prompt for this chunk
              cat prompt-header.md > prompt-chunk.md
              {
                echo ""
                echo "## Pull Request Diff (Part $CHUNK_NUM of $NUM_CHUNKS)"
                echo '```diff'
                cat "$chunk_file"
                echo '```'
                echo ""
                echo "**Note**: This is part $CHUNK_NUM of $NUM_CHUNKS. Focus on reviewing the code shown above."
              } >> prompt-chunk.md

              echo "Chunk prompt size: $(wc -c < prompt-chunk.md) bytes"

              # Review this chunk
              if ! cat prompt-chunk.md | claude > "review-chunk-${CHUNK_NUM}.txt" 2>&1; then
                echo "‚ùå ERROR: Claude code review failed on chunk $CHUNK_NUM"
                echo "Review output:"
                cat "review-chunk-${CHUNK_NUM}.txt"
                exit 1
              fi

              echo "‚úÖ Chunk $CHUNK_NUM reviewed ($(wc -l < review-chunk-${CHUNK_NUM}.txt) lines)"
            done

            # Combine all reviews in sorted order
            echo "Combining reviews..."
            {
              echo "# Combined Code Review"
              echo ""
              for i in $(seq 1 $NUM_CHUNKS); do
                echo "## Review Part $i of $NUM_CHUNKS"
                echo ""
                cat "review-chunk-${i}.txt"
                echo ""
                echo "---"
                echo ""
              done
            } > review.txt

            # Cleanup
            rm chunk_* review-chunk-*.txt prompt-chunk.md

            echo "‚úÖ All chunks reviewed and combined"

          else
            echo "‚úÖ PR size is manageable, processing as single review..."

            # Create single prompt
            cat prompt-header.md > prompt-temp.md
            {
              echo ""
              echo "## Pull Request Diff"
              echo '```diff'
              cat pr_diff.txt
              echo '```'
            } >> prompt-temp.md

            echo "Prompt size: $(wc -c < prompt-temp.md) bytes"

            # Show first and last few lines of prompt to verify it's complete
            echo "First 5 lines of prompt:"
            head -5 prompt-temp.md
            echo "Last 5 lines of prompt:"
            tail -5 prompt-temp.md

            # Pass prompt via stdin
            echo "Calling Claude CLI..."
            if ! cat prompt-temp.md | claude > review.txt 2>&1; then
              echo "‚ùå ERROR: Claude code review failed"
              echo "Review output:"
              cat review.txt
              exit 1
            fi

            echo "‚úÖ Review completed"
          fi

          # Show the actual review output for debugging
          echo ""
          echo "Review output (first 50 lines):"
          head -50 review.txt

          if [ ! -s review.txt ]; then
            echo "‚ùå ERROR: Claude produced empty review"
            exit 1
          fi

          echo ""
          echo "‚úÖ Code review completed ($(wc -l < review.txt) lines total)"

      - name: Post review comment
        env:
          GH_TOKEN: ${{ github.token }}
        if: env.SKIP_REVIEW != 'true'
        run: |
          echo "Posting review to PR..."
          gh pr comment ${{ github.event.pull_request.number }} --body "## ü§ñ Claude Code Review
          $(cat review.txt)
          ---
          *Automated code review analyzing defects and coding standards*"
          echo "‚úÖ Review posted to PR #${{ github.event.pull_request.number }}"

      - name: Post skip message
        env:
          GH_TOKEN: ${{ github.token }}
        if: env.SKIP_REVIEW == 'true'
        run: |
          echo "Posting skip message to PR..."
          gh pr comment ${{ github.event.pull_request.number }} --body "## ü§ñ Claude Code Review

          ‚ö†Ô∏è **No file changes detected** - skipping code review.

          This PR appears to contain only metadata changes (labels, description, etc.)."
          echo "‚úÖ Skip message posted to PR #${{ github.event.pull_request.number }}"
