name: Claude Pull Request Review
on:
  workflow_call:
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        required: true
permissions: {}
jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Install Claude Code CLI
        run: |
          echo "Installing Claude Code CLI..."

          # Download install script
          curl -fsSL https://claude.ai/install.sh -o install.sh

          # Calculate checksum of downloaded script
          SCRIPT_CHECKSUM=$(sha256sum install.sh | awk '{print $1}')
          echo "Install script checksum: $SCRIPT_CHECKSUM"

          # TODO: Verify against known good checksum when available from Claude documentation
          # EXPECTED_CHECKSUM="..."
          # if [ "$SCRIPT_CHECKSUM" != "$EXPECTED_CHECKSUM" ]; then
          #   echo "‚ùå ERROR: Install script checksum verification failed!"
          #   exit 1
          # fi

          # Execute install script
          bash install.sh

          # Add to PATH
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

          # Cleanup
          rm install.sh

      - name: Verify Claude CLI installation
        run: |
          # Verify installation succeeded
          if ! command -v claude &> /dev/null; then
            echo "‚ùå ERROR: Claude CLI installation failed"
            exit 1
          fi
          claude --version
          echo "‚úÖ Claude CLI installed successfully"
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      - name: Get PR diff
        run: |
          echo "Fetching PR diff..."
          gh pr diff ${{ github.event.pull_request.number }} > pr_diff.txt || true

          if [ ! -s pr_diff.txt ]; then
            echo "‚ö†Ô∏è  PR diff is empty (no file changes detected)"
            echo "This PR may only contain metadata changes (labels, title, etc.)"
            echo "Skipping code review..."
            echo "SKIP_REVIEW=true" >> "$GITHUB_ENV"
            exit 0
          fi

          echo "‚úÖ PR diff retrieved ($(wc -l < pr_diff.txt) lines)"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Checkout build resources
        uses: actions/checkout@v5
        with:
          path: build-resources
          persist-credentials: false
          repository: senzing-factory/build-resources  # Replace with actual repo
          token: ${{ secrets.GITHUB_TOKEN }}  # Or a PAT if private repo

      - name: Create review prompt
        if: env.SKIP_REVIEW != 'true'
        run: |
          cp build-resources/claude/pr-prompt.md prompt-temp.md
          {
            echo ""
            echo "## Pull Request Diff"
            echo '```diff'
            cat pr_diff.txt
            echo '```'
          } >> prompt-temp.md
          echo "‚úÖ Review prompt created ($(wc -l < prompt-temp.md) lines)"

      - name: Run Claude Code Review
        if: env.SKIP_REVIEW != 'true'
        run: |
          echo "Running Claude code review..."
          # The CLAUDE_CODE_OAUTH_TOKEN is used by Claude CLI for authentication
          # Use stdin to avoid "Argument list too long" error with large diffs
          if ! cat prompt-temp.md | claude -p - > review.txt; then
            echo "‚ùå ERROR: Claude code review failed"
            echo "This may be due to:"
            echo "  - Invalid or missing CLAUDE_CODE_OAUTH_TOKEN"
            echo "  - Network connectivity issues"
            echo "  - Claude API errors"
            exit 1
          fi
          if [ ! -s review.txt ]; then
            echo "‚ùå ERROR: Claude produced empty review"
            exit 1
          fi
          echo "‚úÖ Code review completed ($(wc -l < review.txt) lines)"
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      - name: Post review comment
        if: env.SKIP_REVIEW != 'true'
        run: |
          echo "Posting review to PR..."
          gh pr comment ${{ github.event.pull_request.number }} --body "## ü§ñ Claude Code Review
          $(cat review.txt)
          ---
          *Automated code review analyzing defects and coding standards*"
          echo "‚úÖ Review posted to PR #${{ github.event.pull_request.number }}"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Post skip message
        if: env.SKIP_REVIEW == 'true'
        run: |
          echo "Posting skip message to PR..."
          gh pr comment ${{ github.event.pull_request.number }} --body "## ü§ñ Claude Code Review

          ‚ö†Ô∏è **No file changes detected** - skipping code review.

          This PR appears to contain only metadata changes (labels, description, etc.)."
          echo "‚úÖ Skip message posted to PR #${{ github.event.pull_request.number }}"
        env:
          GH_TOKEN: ${{ github.token }}
