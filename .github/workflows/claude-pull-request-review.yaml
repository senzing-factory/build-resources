name: Claude Pull Request Review

on:
  workflow_call:
    secrets:
      SLACK_BOT_TOKEN:
        required: true

permissions: {}

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}" ]; then
            echo "‚ùå ERROR: CLAUDE_CODE_OAUTH_TOKEN secret is not set"
            echo "Please add the secret in repository settings:"
            echo "Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret"
            exit 1
          fi
          echo "‚úÖ CLAUDE_CODE_OAUTH_TOKEN secret is configured"

      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Install Claude Code CLI
        run: |
          echo "Installing Claude Code CLI..."
          curl -fsSL https://claude.ai/install.sh | bash
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Verify Claude CLI installation
        run: |
          # Verify installation succeeded
          if ! command -v claude &> /dev/null; then
            echo "‚ùå ERROR: Claude CLI installation failed"
            exit 1
          fi
          claude --version
          echo "‚úÖ Claude CLI installed successfully"
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      - name: Get PR diff
        run: |
          echo "Fetching PR diff..."
          gh pr diff ${{ github.event.pull_request.number }} > pr_diff.txt

          if [ ! -s pr_diff.txt ]; then
            echo "‚ùå ERROR: PR diff is empty"
            exit 1
          fi

          echo "‚úÖ PR diff retrieved ($(wc -l < pr_diff.txt) lines)"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create review prompt
        run: |
          # Use temp file instead of modifying checked-in file
          cp claude/pr-prompt.md prompt-temp.md

          {
            echo ""
            echo "## Pull Request Diff"
            echo '```diff'
            cat pr_diff.txt
            echo '```'
          } >> prompt-temp.md

          echo "‚úÖ Review prompt created ($(wc -l < prompt-temp.md) lines)"

      - name: Run Claude Code Review
        run: |
          echo "Running Claude code review..."

          # The CLAUDE_CODE_OAUTH_TOKEN is used by Claude CLI for authentication
          # No additional OIDC setup needed - the token handles authentication

          # Use stdin to avoid "Argument list too long" error with large diffs
          if ! cat prompt-temp.md | claude -p - > review.txt; then
            echo "‚ùå ERROR: Claude code review failed"
            exit 1
          fi

          if [ ! -s review.txt ]; then
            echo "‚ùå ERROR: Claude produced empty review"
            exit 1
          fi

          echo "‚úÖ Code review completed ($(wc -l < review.txt) lines)"
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      - name: Post review comment
        run: |
          echo "Posting review to PR..."

          gh pr comment ${{ github.event.pull_request.number }} --body "## ü§ñ Claude Code Review

          $(cat review.txt)

          ---
          *Automated code review analyzing defects and coding standards*"

          echo "‚úÖ Review posted to PR #${{ github.event.pull_request.number }}"
        env:
          GH_TOKEN: ${{ github.token }}
